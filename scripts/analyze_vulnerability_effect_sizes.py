#!/usr/bin/env python3
"""
Vulnerability effect size analysis for Module 3 (VulnCausal).

Analyzes:
1. Effect size distribution of top hits vs genome-wide background
2. Volcano plot data (effect size vs significance)
3. Comparison of differential vs learned method rankings
4. Category-specific effect size analysis

Usage:
    python scripts/analyze_vulnerability_effect_sizes.py
"""

import logging
from pathlib import Path

import numpy as np
import pandas as pd
from scipy import stats

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


def main():
    data_dir = Path("data")

    # Load vulnerability data
    diff_full = pd.read_csv(data_dir / "vulnerabilities" / "differential_dependency_full.csv")
    top100 = pd.read_csv(data_dir / "vulnerabilities" / "top_100_vulnerabilities.csv")
    combined = pd.read_csv(data_dir / "vulnerabilities" / "combined_vulnerabilities.csv")

    logger.info(f"Genome-wide genes: {len(diff_full)}")
    logger.info(f"Top 100 candidates: {len(top100)}")
    logger.info(f"Combined vulnerabilities: {len(combined)}")

    # 1. Effect size distributions
    logger.info(f"\n{'='*60}")
    logger.info("EFFECT SIZE DISTRIBUTIONS")
    logger.info(f"{'='*60}")

    all_effects = diff_full["effect_size"].dropna()
    top100_effects = top100["effect_size"].dropna() if "effect_size" in top100.columns else pd.Series()
    top47_genes = combined.head(47)["gene"].tolist() if len(combined) >= 47 else combined["gene"].tolist()
    top47_effects = diff_full[diff_full["gene"].isin(top47_genes)]["effect_size"]

    logger.info(f"\n  Genome-wide (n={len(all_effects)}):")
    logger.info(f"    Mean: {all_effects.mean():.4f}")
    logger.info(f"    Median: {all_effects.median():.4f}")
    logger.info(f"    SD: {all_effects.std():.4f}")
    logger.info(f"    Negative (ecDNA+ more dependent): {(all_effects < 0).sum()} ({(all_effects < 0).mean():.1%})")

    if len(top100_effects) > 0:
        logger.info(f"\n  Top 100 (n={len(top100_effects)}):")
        logger.info(f"    Mean: {top100_effects.mean():.4f}")
        logger.info(f"    Median: {top100_effects.median():.4f}")
        logger.info(f"    SD: {top100_effects.std():.4f}")
        logger.info(f"    All negative: {(top100_effects < 0).all()}")

    if len(top47_effects) > 0:
        logger.info(f"\n  Top 47 (n={len(top47_effects)}):")
        logger.info(f"    Mean: {top47_effects.mean():.4f}")
        logger.info(f"    Median: {top47_effects.median():.4f}")

    # KS test: top 100 vs background
    if len(top100_effects) > 0:
        ks_stat, ks_p = stats.ks_2samp(top100_effects, all_effects)
        logger.info(f"\n  KS test (top 100 vs genome-wide): D={ks_stat:.3f}, p={ks_p:.2e}")

    # 2. Significance analysis
    logger.info(f"\n{'='*60}")
    logger.info("SIGNIFICANCE THRESHOLDS")
    logger.info(f"{'='*60}")

    if "fdr" in diff_full.columns:
        for threshold in [0.05, 0.01, 0.001]:
            n_sig = (diff_full["fdr"] < threshold).sum()
            logger.info(f"  FDR < {threshold}: {n_sig} genes ({n_sig/len(diff_full):.1%})")

    if "pvalue" in diff_full.columns:
        for threshold in [0.05, 0.01, 0.001]:
            n_sig = (diff_full["pvalue"] < threshold).sum()
            logger.info(f"  Nominal p < {threshold}: {n_sig} genes ({n_sig/len(diff_full):.1%})")

    # 3. Category analysis
    logger.info(f"\n{'='*60}")
    logger.info("EFFECT SIZES BY FUNCTIONAL CATEGORY")
    logger.info(f"{'='*60}")

    if "category" in diff_full.columns:
        for cat in sorted(diff_full["category"].unique()):
            cat_data = diff_full[diff_full["category"] == cat]
            logger.info(f"\n  {cat} (n={len(cat_data)}):")
            logger.info(f"    Mean effect: {cat_data['effect_size'].mean():.4f}")
            if "cohens_d" in cat_data.columns:
                logger.info(f"    Mean |d|: {cat_data['cohens_d'].abs().mean():.3f}")
            n_sig = (cat_data["fdr"] < 0.05).sum() if "fdr" in cat_data.columns else 0
            logger.info(f"    FDR < 0.05: {n_sig}")

    # 4. Validated gene details
    logger.info(f"\n{'='*60}")
    logger.info("VALIDATED GENES DETAIL")
    logger.info(f"{'='*60}")

    validated_genes = [
        "CHK1", "CDK1", "KIF11", "NCAPD2", "SGO1", "NDC80", "ORC6",
        "MCM2", "PSMD7", "RPL23", "URI1", "SNRPF", "DDX3X", "BCL2L1"
    ]

    for gene in validated_genes:
        row = diff_full[diff_full["gene"] == gene]
        if len(row) == 0:
            # Try CHEK1 for CHK1
            if gene == "CHK1":
                row = diff_full[diff_full["gene"] == "CHEK1"]
        if len(row) > 0:
            r = row.iloc[0]
            fdr_str = f"{r['fdr']:.4f}" if "fdr" in r and not pd.isna(r.get("fdr")) else "N/A"
            d_str = f"{r['cohens_d']:.3f}" if "cohens_d" in r and not pd.isna(r.get("cohens_d")) else "N/A"
            logger.info(f"  {gene:>8s}: effect={r['effect_size']:+.4f}, d={d_str}, FDR={fdr_str}")
        else:
            logger.info(f"  {gene:>8s}: NOT FOUND in differential analysis")

    # 5. Method comparison (differential vs learned)
    if "combined_rank" in top100.columns and "vulnerability_score" in top100.columns:
        logger.info(f"\n{'='*60}")
        logger.info("METHOD COMPARISON")
        logger.info(f"{'='*60}")

        # Check if learned vulnerabilities exist
        learned_path = data_dir / "vulnerabilities" / "learned_vulnerabilities.csv"
        if learned_path.exists():
            learned = pd.read_csv(learned_path)
            # Compare rankings
            diff_top50 = set(diff_full.nsmallest(50, "pvalue")["gene"])
            learned_top50 = set(learned.head(50)["gene"]) if len(learned) >= 50 else set(learned["gene"])
            overlap = diff_top50 & learned_top50
            logger.info(f"  Differential top 50: {len(diff_top50)} genes")
            logger.info(f"  Learned top 50: {len(learned_top50)} genes")
            logger.info(f"  Overlap: {len(overlap)} genes ({len(overlap)/50:.1%})")
            if overlap:
                logger.info(f"  Shared: {', '.join(sorted(overlap))}")

    # Save volcano plot data
    output_dir = data_dir / "validation"
    output_dir.mkdir(exist_ok=True)

    volcano = diff_full[["gene", "effect_size", "cohens_d", "pvalue", "fdr"]].copy()
    volcano["neg_log10_p"] = -np.log10(volcano["pvalue"].clip(lower=1e-300))
    volcano["significant"] = volcano["fdr"] < 0.05
    volcano["in_top100"] = volcano["gene"].isin(top100["gene"] if len(top100) > 0 else [])
    volcano["validated"] = volcano["gene"].isin(validated_genes + ["CHEK1"])
    volcano.to_csv(output_dir / "volcano_data.csv", index=False)

    summary = {
        "n_genes_total": len(diff_full),
        "n_fdr_005": int((diff_full["fdr"] < 0.05).sum()) if "fdr" in diff_full.columns else 0,
        "mean_effect_top100": float(top100_effects.mean()) if len(top100_effects) > 0 else None,
        "mean_effect_genomewide": float(all_effects.mean()),
        "n_negative_genomewide": int((all_effects < 0).sum()),
    }
    pd.DataFrame([summary]).to_csv(output_dir / "vulnerability_effect_summary.csv", index=False)

    logger.info(f"\nSaved to {output_dir}")


if __name__ == "__main__":
    main()
